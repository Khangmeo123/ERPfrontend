<div class="page goods-receipt-po">
  <div class="page-header">
    <span class="page-title">
      {{pageTitle | translate}}
      <span (click)="bookMark()">
        <mat-icon [ngClass]="!isBookMark ? 'save-book-mark': 'not-save-book-mark'">
          star
        </mat-icon>
      </span>
    </span>
    <div class="page-actions d-flex">
      <button (click)="addGoodsReceipt()" class="btn btn-labeled btn-add" data-qe-id="button-add" type="button">
        <span class="btn-label"><i class="material-icons">add</i></span>
        <span class="button-label">
          {{'general.button.add' | translate}}
        </span></button>
      <button (click)="clearSearch(table)" class="btn btn-labeled btn-clear" data-qe-id="button-clear">
        <span class="btn-label">
          <img src="/assets/img/filter.svg" width="16">
        </span>
        <span class="button-label">
          {{'general.button.clear' | translate}}
        </span>
      </button>
    </div>

  </div>
  <div class="page-body">
    <div class="page-section">
      <div class="row d-flex pb-3">
        <div class="col-sm-2 d-flex date-picker align-items-center n-p-r">
          <label class="">{{'general.fromDate' | translate}}</label>
          <input [(ngModel)]="goodsReceiptPOSearchEntity.documentDate.greaterEqual"
                 [matDatepicker]="picker" class="form-control input-datepicker ml-1 mr-1"
                 data-qe-id="input-date-from" matInput
                 placeholder="dd/mm/yyyy">
          <mat-datepicker #picker></mat-datepicker>
          <div (click)="picker.open()" data-qe-id="button-date-from" role="button">
            <mat-icon>calendar_today</mat-icon>
          </div>
        </div>
        <div class="col-sm-2 d-flex date-picker align-items-center n-p-l  n-p-r">
          <label>{{'general.toDate' | translate}}</label>
          <input [(ngModel)]="goodsReceiptPOSearchEntity.documentDate.lessEqual" [matDatepicker]="datepicker"
                 class="form-control input-datepicker ml-1 mr-1"
                 data-qe-id="input-date-to" matInput
                 placeholder="dd/mm/yyyy">
          <mat-datepicker #datepicker></mat-datepicker>
          <div (click)="datepicker.open()" data-qe-id="button-date-from" role="button">
            <mat-icon>calendar_today</mat-icon>
          </div>
        </div>
        <button (click)="getList()" class="btn btn-labeled btn-add get-data" data-qe-id="button-fetchData"
                type="button">
          {{'general.button.getData' | translate}}</button>
      </div>
      <p-table #table
               (onLazyLoad)="sort($event)"
               [customSort]="true"
               [lazy]="true"
               [columns]="selectedColumns"
               [resizableColumns]="true"
               dataKey="id"
               [scrollable]="true"
               [value]="goodsReceiptPOList"
               scrollHeight="512px">
        <ng-template pTemplate="header">
          <tr>
            <th [ngStyle]="{width: '4em'}" pResizableColumn></th>
            <th data-qe-id="table-thead-documentNumber" pResizableColumn *ngIf="selectedKeys?.documentNumber">
              {{ 'goodsReceiptPO.purchaseOrderNumber' | translate}}
              <p-sortIcon class="float-right"></p-sortIcon>
            </th>
            <th data-qe-id="table-thead-documentDate" pResizableColumn *ngIf="selectedKeys?.postingDate">
              {{ 'goodsReceiptPO.createdDate' | translate}}
              <p-sortIcon class="float-right"></p-sortIcon>
            </th>
            <th data-qe-id="table-thead-dueDate" pResizableColumn *ngIf="selectedKeys?.dueDate">
              {{ 'goodsReceiptPO.receiptedDate' | translate}}
              <p-sortIcon class="float-right"></p-sortIcon>
            </th>
            <th data-qe-id="table-thead-inventoryOrganizationCode" pResizableColumn
                *ngIf="selectedKeys?.inventoryOrganization">
              {{ 'goodsReceiptPO.inventory' | translate}}
              <p-sortIcon class="float-right"></p-sortIcon>
            </th>
            <th data-qe-id="table-thead-remarks" pResizableColumn *ngIf="selectedKeys?.remarks">
              {{ 'goodsReceiptPO.description' | translate}}
              <p-sortIcon class="float-right"></p-sortIcon>
            </th>
            <th data-qe-id="table-thead-requester" pResizableColumn *ngIf="selectedKeys?.requester">
              {{ 'goodsReceiptPO.creator' | translate}}
              <p-sortIcon class="float-right"></p-sortIcon>
            </th>
            <th data-qe-id="table-thead-status" pResizableColumn *ngIf="selectedKeys?.status">
              {{ 'goodsReceiptPO.status' | translate}}
              <p-sortIcon class="float-right"></p-sortIcon>
            </th>
            <th class="actions" pResizableColumn> {{'general.action' | translate }} </th>
          </tr>
          <tr>
            <th class="th-filter" [ngStyle]="{width: '4em'}" pResizableColumn>
            </th>
            <th class="th-filter">
              <app-advanced-filters (changeFilter)="getList()" [filter]="goodsReceiptPOSearchEntity.documentNumber"
                                    data-qe-id="table-thead-filter-documentNumber">
              </app-advanced-filters>
            </th>
            <th class="th-filter">
            </th>
            <th class="th-filter" *ngIf="selectedKeys?.dueDate">
              <app-advanced-filters (changeFilter)="getList()" [filter]="goodsReceiptPOSearchEntity.dueDate"
                                    data-qe-id="table-thead-filter-dueDate">
              </app-advanced-filters>
            </th>
            <th class="th-filter" *ngIf="selectedKeys?.inventoryOrganization">
              <jaja-select-list
                (change)="onFilterInventoryOrganization($event)"
                [display]="goodsReceiptPOSearchEntity.inventoryOrganizationCode"
                [getList]="goodsReceiptPOListRepository.singleListInventoryOrganization"
                [searchEntity]="inventoryOrganizationSearchEntity"
                [searchable]="true"
                appendTo="body"
                placeholder="{{'goodsReceiptPOList.filters.inventoryOrganizationCode' | translate}}"
                searchField="code"
                searchType="startsWith">
                <ng-template #label #option let-code="code" let-name="name">
                  {{code}} - {{name}}
                </ng-template>
              </jaja-select-list>
            </th>
            <th class="th-filter" *ngIf="selectedKeys?.remarks">
              <app-advanced-filters (changeFilter)="getList()" [filter]="goodsReceiptPOSearchEntity.remarks"
                                    data-qe-id="table-thead-filter-remarks">
              </app-advanced-filters>
            </th>
            <th class="th-filter" *ngIf="selectedKeys?.requester">
              <jaja-select-list
                (change)="onFilterRequester($event)"
                [display]="goodsReceiptPOSearchEntity?.requesterName"
                [getList]="goodsReceiptPOListRepository.singleListRequester"
                [searchEntity]="requesterSearchEntity"
                [searchable]="true"
                appendTo="body"
                placeholder="{{'goodsReceiptPOList.filters.requester' | translate}}"
                searchField="name"
                searchType="startsWith"
              >
                <ng-template #label #option let-name="name">
                  {{name}}
                </ng-template>
              </jaja-select-list>
            </th>
            <th class="th-filter" *ngIf="selectedKeys?.status">
              <jaja-select-list
                (change)="onFilterStatus($event)"
                [display]="goodsReceiptPOSearchEntity?.statusDisplay"
                [getList]="goodsReceiptPOListRepository.enumListStatus"
                appendTo="body"
                placeholder="{{'goodsReceiptPOList.filters.status' | translate}}">
                <ng-template #label #option let-display="display">
                  {{display}}
                </ng-template>
              </jaja-select-list>
            </th>
            <th class="th-filter actions">
              <p-multiSelect [options]="columns"
                             [(ngModel)]="selectedColumns"
                             optionLabel="header"
                             selectedItemsLabel=""
                             [style]="{minWidth: '200px'}"
                             (onChange)="onChangeColumns($event)"
                             defaultLabel=""></p-multiSelect>
            </th>
          </tr>
        </ng-template>
        <ng-template let-goodsReceiptPO let-index="rowIndex" pTemplate="body" let-expanded="expanded">
          <tr [attr.data-qe-id]="'table-tbody-row-' + index">
            <td class="ui-resizable-column" [ngStyle]="{width: '4em'}" pResizableColumn>
              <a role="button" class="btn btn-link text-primary" [pRowToggler]="goodsReceiptPO"
                 (click)="onGetContent(goodsReceiptPO)">
                <i class="material-icons">{{expanded ? 'remove' : 'add'}}</i>
              </a>
            </td>
            <td class="ui-resizable-column"
                *ngIf="selectedKeys?.documentNumber"> {{goodsReceiptPO.documentNumber}} </td>
            <td class="ui-resizable-column"
                *ngIf="selectedKeys?.postingDate"> {{goodsReceiptPO.documentDate | date: 'dd/MM/yyyy'}} </td>
            <td class="ui-resizable-column"
                *ngIf="selectedKeys?.dueDate"> {{goodsReceiptPO.dueDate | date: 'dd/MM/yyyy'}} </td>
            <td class="ui-resizable-column"
                *ngIf="selectedKeys?.inventoryOrganization"> {{goodsReceiptPO.inventoryOrganizationCode}}
              - {{goodsReceiptPO.inventoryOrganizationStreet}} </td>
            <td class="ui-resizable-column"
                *ngIf="selectedKeys?.remarks"> {{goodsReceiptPO.remarks }} </td>
            <td class="ui-resizable-column"
                *ngIf="selectedKeys?.requester"> {{goodsReceiptPO.requesterName }} </td>
            <td class="text-center ui-resizable-column"
                *ngIf="selectedKeys?.status">
              <div [ngSwitch]="goodsReceiptPO.statusName">/
                <a *ngSwitchCase="'OPEN'" [queryParams]="{id: goodsReceiptPO.id}"
                   class="ml-2 open-status"
                   routerLink="/inventory/receipt/goods-receipt-po/goods-receipt-po-detail">{{'general.open'| translate}}</a>
                <a *ngSwitchCase="'PENDING_APPROVAL'" [queryParams]="{id: goodsReceiptPO.id}"
                   class="ml-2 pending-status"
                   routerLink="/inventory/receipt/goods-receipt-po/goods-receipt-po-approve">{{'general.pending'| translate}}</a>
                <a *ngSwitchCase="'PENDING_RECEIVE'"
                   [queryParams]="{id: goodsReceiptPO.id}"
                   class="ml-2 pending-receive-status"
                   routerLink="/inventory/receipt/goods-receipt-po/goods-receipt-po-receive">{{'general.pendingReceive'| translate}}</a>
                <a *ngSwitchCase="'DONE'" [queryParams]="{id: goodsReceiptPO.id}"
                   class="ml-2 done-status"
                   routerLink="/inventory/receipt/goods-receipt-po/goods-receipt-po-approve">{{'general.done'| translate}}</a>
              </div>
            </td>
            <td class="actions">
              <div class="view-detail d-flex justify-content-center">
                <mat-icon>remove_red_eye</mat-icon>
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="rowexpansion" let-rowData let-rowIndex="rowIndex">
          <tr>
            <td [attr.colspan]="2"></td>
            <td [attr.colspan]="8">
              <table class="ui-table" *ngIf="rowData.goodsReceiptPOContents; else tableLoading">
                <thead>
                <tr>
                  <th data-qe-id="table-thead-purchase-order-number" pResizableColumn>
                    {{'goodsReceiptPO.goodsReceiptPOContents.purchaseOrderNumber' | translate}}
                  </th>
                  <th data-qe-id="table-thead-item-no" pResizableColumn>
                    {{'goodsReceiptPO.goodsReceiptPOContents.itemNo' | translate}} </th>
                  <th data-qe-id="table-thead-purchase-order-number" pResizableColumn>
                    {{'goodsReceiptPO.goodsReceiptPOContents.itemName' | translate}} </th>
                  <th data-qe-id="table-thead-unit-of-measure" pResizableColumn>
                    {{'goodsReceiptPO.goodsReceiptPOContents.unitOfMeasure' | translate}}
                  </th>
                  <th data-qe-id="table-thead-quantity" pResizableColumn>
                    {{'goodsReceiptPO.goodsReceiptPOContents.quantity' | translate}} </th>
                  <th data-qe-id="table-thead-unit-of-measure" pResizableColumn>
                    {{'goodsReceiptPO.goodsReceiptPOContents.unitPrice' | translate}}
                  </th>
                  <th data-qe-id="table-thead-value-added-tax" pResizableColumn>
                    {{'goodsReceiptPO.goodsReceiptPOContents.valueAddedTax' | translate}}
                    (%)
                  </th>
                  <th data-qe-id="table-thead-discount" pResizableColumn>
                    {{'goodsReceiptPO.goodsReceiptPOContents.discount' | translate}} (%)
                  </th>
                  <th data-qe-id="table-thead-discount-amount" pResizableColumn>
                    {{'goodsReceiptPO.goodsReceiptPOContents.discountAmount' | translate}}
                  </th>
                  <th class="value">
                    {{'goodsReceiptPO.goodsReceiptPOContents.total' | translate}}
                  </th>
                </tr>
                </thead>
                <tbody class="ui-table-tbody">
                <tr *ngFor="let goodsReceiptPOContent of rowData.goodsReceiptPOContents">
                  <td class="ui-resizable-column">{{goodsReceiptPOContent.documentNumber}}</td>
                  <td class="ui-resizable-column">{{goodsReceiptPOContent.itemCode}}</td>
                  <td class="ui-resizable-column">{{goodsReceiptPOContent.itemName}}</td>
                  <td class="ui-resizable-column">{{goodsReceiptPOContent.unitOfMeasureName}}</td>
                  <td class="ui-resizable-column">
                    {{goodsReceiptPOContent.quantity}}
                  </td>
                  <td class="ui-resizable-column text-right">{{goodsReceiptPOContent.unitPrice}}
                  </td>
                  <td class="ui-resizable-column text-right">{{goodsReceiptPOContent.taxRate}}
                  </td>
                  <td class="ui-resizable-column text-right">
                    {{goodsReceiptPOContent.itemDiscountRate}}
                  </td>
                  <td class="ui-resizable-column text-right">
                    {{goodsReceiptPOContent.itemDiscountCost}}
                  </td>
                  <td class="text-right value">
                    {{goodsReceiptPOContent.total}}
                  </td>
                </tr>
                </tbody>
              </table>
              <ng-template #tableLoading>
                <div class="table-loading">
                  <nz-spin nzSimple></nz-spin>
                </div>
              </ng-template>
            </td>
          </tr>
        </ng-template>
        <div class="pagination flex-grow-1">
          <app-pagination (paginationOut)="paginationOut($event)" [pagination]="pagination" data-qe-id="pagination">
          </app-pagination>
        </div>
      </p-table>
    </div>
  </div>
</div>
