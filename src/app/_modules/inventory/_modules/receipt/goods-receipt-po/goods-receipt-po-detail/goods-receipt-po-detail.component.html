<div class="page goods-receipt-po">

  <div class="page-header justify-content-between">
    <div class="justify-content-start align-items-center">
            <span (click)="backToList()" class="back-to-list">
                <i class="material-icons">arrow_back_ios</i>
            </span>
      <span class="page-title">
                {{'goodsReceiptPODetail.header.title' | translate}}
            </span>
      <span class="ml-2 open-status">{{'general.open'| translate}}</span>
    </div>

    <div class="page-actions d-flex">
      <button (click)="send()" class="btn btn-labeled btn-send" data-qe-id="button-send">
        <span class="btn-label"><i class="material-icons">send</i></span>
        <span class="button-label">
                    {{'general.button.send' | translate}}
                </span></button>
      <button (click)="save()" class="btn btn-labeled btn-save" data-qe-id="button-save">
        <span class="btn-label"><i class="material-icons">save</i></span>
        <span class="button-label">
                    {{'general.button.save' | translate}}
                </span></button>
      <div class="btn-group btn-labeled" data-qe-id="button-action" dropdown>
        <button aria-controls="dropdown-basic" class="btn btn-labeled btn-import" dropdownToggle id="button-basic">
          <span class="btn-label">
            <i class="material-icons">arrow_drop_down</i>
          </span>
          <span class="button-label">
                        {{'general.action' | translate}}
                    </span></button>
        <ul *dropdownMenu
            aria-labelledby="button-basic"
            class="dropdown-menu dropdown-menu-right"
            id="dropdown-basic"
            role="menu">
          <li role="menuitem">
            <a class="dropdown-item" href="#">{{'general.button.history' | translate}}</a>
          </li>
          <li class="divider dropdown-divider"></li>
          <li role="menuitem">
            <a class="dropdown-item" href="#">{{'general.button.print' | translate}}</a>
          </li>
          <li class="divider dropdown-divider"></li>
          <li role="menuitem">
            <a class="dropdown-item" href="#">{{'general.button.referenceDocument' | translate}}</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <div [formGroup]="goodsReceiptPOForm" class="page-body">
    <div class="page-section">
      <div class="page-section-form-header">
                <span class="form-title">
                    {{'goodsReceiptPODetail.form.title' | translate}}
                </span>
        <div class="page-actions justify-content-end">
          <button (click)="deactivate()" *ngIf="goodsReceiptPOId!==null && goodsReceiptPOId!==undefined"
                  class="btn btn-labeled btn-delete">
            <span class="btn-label"><i class="material-icons">delete</i></span>
            <span class="button-label">
                            {{'general.button.delete' | translate}}
                        </span></button>
        </div>
      </div>
      <div class="line"></div>
      <div class="page-section-form-body">
        <div class="row">
          <div class="col-sm-4 form-group">
            <label>
              {{'goodsReceiptPODetail.supplierCode' | translate}}
              <span class="text-danger mr-2">*</span>
            </label>
            <div class="div-form">
              <jaja-select-list class="flex-grow-1"
                                [getList]="goodsReceiptPoDetailRepository.getSupplierList"
                                (change)="onSelectSupplierDetail($event)"
                                [display]="supplierCode?.value"
                                [searchable]="true"
                                [searchEntity]="supplierSearchEntity"
                                searchField="code">
                <ng-template #label #option let-code="code" let-name="name">
                  {{code}} - {{name}}
                </ng-template>
              </jaja-select-list>
              <app-error [formGroup]="goodsReceiptPOForm"
                         [placement]="'top'"
                         [property]="'supplierDetailId'"
                         class="error-form"
                         data-qe-id="form-error-supplier-code">
              </app-error>
            </div>
          </div>
          <div class="col-sm-4 form-group">
            <label for="detail-form-supplier-name">
              {{'goodsReceiptPODetail.supplierName' | translate}}
            </label>
            <input class="form-control disabled"
                   id="detail-form-supplier-name"
                   data-qe-id="detail-form-supplier-name"
                   formControlName="supplierName"
                   type="text">
          </div>
          <div class="col-sm-4 form-group">
            <label>
              {{'goodsReceiptPODetail.supplierContact' | translate}}
            </label>
            <div class="div-form">
              <jaja-select-list class="flex-grow-1"
                                [getList]="goodsReceiptPoDetailRepository.getSupplierContactList"
                                formControlName="supplierContactId"
                                key="id"
                                [ngClass]="{disabled: !supplierDetailId.value}"
                                [searchable]="true"
                                [searchEntity]="supplierContactSearchEntity"
                                searchField="supplierAddress"
                                [display]="supplierAddress?.value"
                                searchType="contains">
                <ng-template #label #option let-supplierAddress="supplierAddress">
                  {{supplierAddress}}
                </ng-template>
              </jaja-select-list>
              <app-error [formGroup]="goodsReceiptPOForm"
                         [placement]="'top'"
                         [property]="'supplierContactId'"
                         class="error-form"
                         data-qe-id="form-error-supplier-contact"></app-error>
            </div>
          </div>
        </div>
      </div>
      <div class="line"></div>
      <div class="page-section-form-body">
        <div class="row">
          <div class="col-sm-8 form-group">
            <label for="purchase-orders">
              {{'goodsReceiptPODetail.goodsReceipt.title' | translate}}
              <span class="text-danger mr-2">*</span>
            </label>
            <div class="div-form">
              <input (focus)="showPurchaseOrders()"
                     id="purchase-orders"
                     [ngClass]="{disabled: !supplierDetailId?.value?.length}"
                     class="form-control"
                     data-qe-id="detail-form-goods-receipt"
                     formControlName="purchaseOrderName"
                     type="text">
              <app-error [formGroup]="goodsReceiptPOForm"
                         [placement]="'top'"
                         [property]="'purchaseOrderName'"
                         class="error-form"
                         data-qe-id="form-error-supplier-contact"></app-error>
            </div>
          </div>
        </div>
      </div>
      <div class="line"></div>
      <div class="page-section-form-body">
        <div class="row">
          <div class="col-sm-4 form-group">
            <label for="document-number">
              {{'goodsReceiptPODetail.documentNumber' | translate}}
              <span class="text-danger mr-2">*</span>
            </label>
            <div class="div-form d-flex">
              <input id="document-number" class="form-control flex-grow-1 disabled" data-qe-id="detail-form-document-number"
                     formControlName="documentNumber" type="text">
              <app-error [formGroup]="goodsReceiptPOForm"
                         [placement]="'top'"
                         [property]="'ownerId'"
                         class="error-form"
                         data-qe-id="form-error-supplier-contact"></app-error>
            </div>
          </div>
          <div class="col-sm-4 form-group">
            <label>
              {{'goodsReceiptPODetail.inventoryCode' | translate}}
            </label>
            <jaja-select-list [getList]="goodsReceiptPoDetailRepository.getInventoryOrganizationList"
                              [searchable]="true"
                              [display]="inventoryOrganizationCode.value"
                              [searchEntity]="inventoryOrganizationSearchEntity"
                              searchField="code"
                              searchType="startsWith"
                              (change)="onSelectInventoryOrganization($event)">
              <ng-template #label #option let-code="code" let-name="name">
                {{code}} - {{name}}
              </ng-template>
            </jaja-select-list>
          </div>
          <div class="col-sm-4 form-group">
            <label for="inventory-organization-street">
              {{'goodsReceiptPODetail.inventoryAddress' | translate}}
            </label>
            <input type="text" class="form-control disabled" formControlName="inventoryOrganizationStreet"
                   id="inventory-organization-street">
          </div>
        </div>
        <div class="row">
          <div class="col-sm-4 form-group">
            <label>
              {{'goodsReceiptPODetail.personInCharge' | translate}}
              <span class="text-danger mr-2">*</span>
            </label>
            <div class="div-form d-flex">
              <jaja-select-list class="flex-grow-1"
                                [getList]="goodsReceiptPoDetailRepository.getEmployeeDetailList"
                                [searchable]="true"
                                [searchEntity]="ownerSearchEntity"
                                searchField="name"
                                searchType="startsWith"
                                (change)="onSelectOwner($event)"
              >
                <ng-template #label #option let-code="code" let-name="name">
                  {{code}} - {{name}}
                </ng-template>
              </jaja-select-list>
              <app-error [formGroup]="goodsReceiptPOForm"
                         [placement]="'top'"
                         [property]="'ownerId'"
                         class="error-form"
                         data-qe-id="form-error-supplier-contact"></app-error>
            </div>
          </div>
          <div class="col-sm-4 form-group">
            <label>
              {{'goodsReceiptPODetail.receiver' | translate}}
            </label>
            <jaja-select-list [getList]="goodsReceiptPoDetailRepository.getEmployeeDetailList"
                              [searchable]="true"
                              [searchEntity]="buyerSearchEntity"
                              searchField="name"
                              searchType="startsWith"
                              (change)="onSelectBuyer($event)">
              <ng-template #label #option let-code="code" let-name="name">
                {{code}} - {{name}}
              </ng-template>
            </jaja-select-list>
          </div>
          <div class="col-sm-4 form-group">
            <label>
              {{'goodsReceiptPODetail.creator' | translate}}
            </label>
            <jaja-select-list [getList]="goodsReceiptPoDetailRepository.getEmployeeDetailList"
                              [searchable]="true"
                              [searchEntity]="requesterSearchEntity"
                              searchField="name"
                              searchType="startsWith"
                              (change)="onSelectRequester($event)">
              <ng-template #label #option let-code="code" let-name="name">
                {{code}} - {{name}}
              </ng-template>
            </jaja-select-list>
          </div>
        </div>
        <div class="row">
          <div class="col-sm-4 form-group">
            <label>
              {{'goodsReceiptPODetail.receiptedDate' | translate}}
              <span class="text-danger mr-2">*</span>
            </label>
            <div class="div-form">
              <app-date-picker [control]="dueDate" class="w-100" data-qe-id="detail-form-receipted-date">
              </app-date-picker>
              <app-error
                [formGroup]="goodsReceiptPOForm"
                [placement]="'top'"
                property="dueDate"
                class="error-form"
                data-qe-id="form-error-supplierContact">
              </app-error>
            </div>

          </div>
          <div class="col-sm-4 form-group">
            <label>
              {{'goodsReceiptPODetail.createdDate' | translate}}
            </label>
            <app-date-picker [control]="goodsReceiptPOForm.get('documentDate')"
                             [disabled]="true" data-qe-id="detail-form-created-date">
            </app-date-picker>
          </div>
        </div>
        <div class="row">
          <div class="col-sm-12 form-group">
            <label>{{ 'goodsReceiptPODetail.description' | translate}}</label>
            <textarea class="form-control" data-qe-id="detail-form-remarks" formControlName="remarks"
                      rows="4">
                         </textarea>
          </div>
        </div>
      </div>
    </div>
    <div class="page-section">
      <div class="tab-header pt-3 pb-3 pl-3 pr-3">
        <mat-tab-group>
          <mat-tab label="{{'goodsReceiptPODetail.tab1.title' | translate}}">
            <div class="row pt-3 pb-3 pl-3">
              <div class="col-sm-12">
                <div class="page-actions d-flex justify-content-end">
                  <button (click)="onClearSearch(tableGoodsReceiptPOContents)" class="btn btn-labeled btn-clear mr-2"
                          data-qe-id="button-clear">
                                        <span class="btn-label">
                                            <img src="/assets/img/filter.svg" width="16">
                                        </span>
                    <span class="button-label">
                                            {{'general.button.clear' | translate}}
                                        </span>
                  </button>
                  <button (confirm)="deleteItem()"
                          popoverMessage="{{'goodsReceiptPODetail.delete.confirm.message' | translate}}"
                          popoverTitle="{{'goodsReceiptPODetail.delete.confirm.title' | translate}}"
                          class="btn btn-labeled btn-delete"
                          data-qe-id="button-delete-row"
                          mwlConfirmationPopover placement="bottom">
                    <span class="btn-label"><i class="material-icons">delete</i></span>
                    <span class="button-label">
                                            {{'general.button.delete' | translate}}
                                        </span>
                  </button>
                </div>
              </div>

            </div>
            <div class="table" formArrayName="goodsReceiptPOContents">
              <p-table #tableGoodsReceiptPOContents
                       [resizableColumns]="true"
                       [rowTrackBy]="trackByFn"
                       [scrollable]="true"
                       [value]="goodsReceiptPOForm.controls.goodsReceiptPOContents.value"
                       scrollHeight="500px">
                <ng-template pTemplate="colgroup">
                  <colgroup>
                    <col>
                    <col>
                    <col>
                    <col>
                    <col>
                    <col>
                    <col>
                    <col>
                    <col>
                    <col>
                    <col>
                  </colgroup>
                </ng-template>
                <ng-template pTemplate="header">
                  <tr>
                    <th width="2.5%">
                    </th>
                    <th data-qe-id="table-thead-purchase-order-number" pResizableColumn>
                      {{'goodsReceiptPODetail.tab1.purchaseOrderNumber' | translate}} </th>
                    <th data-qe-id="table-thead-item-no" pResizableColumn>
                      {{'goodsReceiptPODetail.tab1.itemNo' | translate}} </th>
                    <th data-qe-id="table-thead-purchase-item-name" pResizableColumn>
                      {{'goodsReceiptPODetail.tab1.itemName' | translate}} </th>
                    <th data-qe-id="table-thead-unit-of-measure" pResizableColumn>
                      {{'goodsReceiptPODetail.tab1.unitOfMeasure' | translate}}
                    </th>
                    <th data-qe-id="table-thead-quantity" pResizableColumn>
                      {{'goodsReceiptPODetail.tab1.quantity' | translate}} </th>
                    <th data-qe-id="table-thead-unit-of-measure" pResizableColumn>
                      {{'goodsReceiptPODetail.tab1.unitPrice' | translate}}
                    </th>
                    <th data-qe-id="table-thead-value-added-tax" pResizableColumn>
                      {{'goodsReceiptPODetail.tab1.valueAddedTax' | translate}}
                      (%)
                    </th>
                    <th data-qe-id="table-thead-discount" pResizableColumn>
                      {{'goodsReceiptPODetail.tab1.discount' | translate}} (%)
                    </th>
                    <th data-qe-id="table-thead-discount-amount" pResizableColumn>
                      {{'goodsReceiptPODetail.tab1.discountAmount' | translate}}
                    </th>
                    <th width="8%">
                      {{'goodsReceiptPODetail.tab1.total' | translate}}</th>
                    <!-- <th pResizableColumn data-qe-id="table-thead-view-detail">
                        {{'general.detail' | translate}}
                    </th> -->
                  </tr>
                  <tr>
                    <th class="th-filter" width="2.5%"></th>
                    <th class="th-filter">
                      <jaja-select-list class="flex-grow-1"
                                        appendTo="body"
                                        [getList]="goodsReceiptPoDetailRepository.getPurchaseOrderList"
                                        [searchEntity]="purchaseOrderSearchEntity"
                                        searchField="code"
                                        searchType="startsWith"
                                        key="code"
                                        [searchable]="true">
                        <ng-template #label #option let-code="code" let-name="name">
                          {{code}} - {{name}}
                        </ng-template>
                      </jaja-select-list>
                    </th>
                    <th class="th-filter">
                      <jaja-select-list class="flex-grow-1"
                                        appendTo="body"
                                        [getList]="goodsReceiptPoDetailRepository.getItemDetailList"
                                        [searchEntity]="itemDetailSearchEntity"
                                        searchField="code"
                                        searchType="startsWith"
                                        key="code"
                                        [searchable]="true">
                        <ng-template #label #option let-code="code" let-name="name">
                          {{code}} - {{name}}
                        </ng-template>
                      </jaja-select-list>
                    </th>
                    <th class="th-filter">
                      <input (input)="tableGoodsReceiptPOContents.filter($event.target.value, 'itemName', 'contains')"
                             class="form-control w-100"
                             type="text"/>
                    </th>
                    <th class="th-filter">
                      <jaja-select-list class="flex-grow-1"
                                        appendTo="body"
                                        [getList]="goodsReceiptPoDetailRepository.getUnitOfMeasureList"
                                        [searchEntity]="unitOfMeasureSearchEntity"
                                        searchField="code"
                                        searchType="startsWith"
                                        key="code"
                                        [searchable]="true">
                        <ng-template #label #option let-code="code">
                          {{code}}
                        </ng-template>
                      </jaja-select-list>
                    </th>
                    <th class="th-filter"></th>
                    <th class="th-filter"></th>
                    <th class="th-filter">
                      <jaja-select-list class="flex-grow-1"
                                        appendTo="body"
                                        [getList]="goodsReceiptPoDetailRepository.getTaxList"
                                        [searchEntity]="taxSearchEntity"
                                        searchField="code"
                                        key="code"
                                        [searchable]="true">
                        <ng-template #label #option let-code="code">
                          {{code}}
                        </ng-template>
                      </jaja-select-list>
                    </th>
                    <th class="th-filter"></th>
                    <th class="th-filter"></th>
                    <th class="th-filter" width="8%"></th>
                  </tr>
                </ng-template>
                <ng-template let-goodsReceiptPOContent let-index="rowIndex" pTemplate="body">
                  <tr [formGroupName]='index'>
                    <td width="2.5%">
                      <div class="pretty p-icon p-curve p-has-indeterminate">
                        <input (change)="addDeletedList(index)" type="checkbox"/>
                        <div class="state">
                          <i class="icon material-icons">done</i>
                          <label></label>
                        </div>
                      </div>
                    </td>
                    <td class="ui-resizable-column">{{goodsReceiptPOContent.documentNumber}}</td>
                    <td class="ui-resizable-column">{{goodsReceiptPOContent.itemCode}}</td>
                    <td class="ui-resizable-column">{{goodsReceiptPOContent.itemName}}</td>
                    <td class="ui-resizable-column">{{goodsReceiptPOContent.unitOfMeasureName}}</td>
                    <td class="ui-resizable-column">
                      <input (input)="recalculateContents()" class="form-control w-100 text-right"
                             formControlName="quantity" pKeyFilter="int"
                             type="text">
                    </td>
                    <td class="ui-resizable-column text-right">{{goodsReceiptPOContent.unitPrice}}
                    </td>
                    <td class="ui-resizable-column text-right">{{goodsReceiptPOContent.taxRate}}
                    </td>
                    <td class="ui-resizable-column text-right">
                      {{goodsReceiptPOContent.generalDiscountRate}}
                    </td>
                    <td class="ui-resizable-column text-right">
                      {{goodsReceiptPOContent.generalDiscountCost}}
                    </td>
                    <td class="text-right" width="8%">
                      {{goodsReceiptPOContent.total | number}}
                    </td>

                  </tr>
                </ng-template>
                <ng-template let-columns pTemplate="footer">
                  <tr>
                    <td class="text-right" colspan="10">{{'general.text.total' | translate}}:</td>
                    <td class="text-right" width="8%">
                      {{ goodsReceiptPOForm.controls.totalGoodsReceiptPOContents.value | number}}
                    </td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
          </mat-tab>
          <mat-tab label="{{'goodsReceiptPODetail.tab2.title' | translate}}">
            <div class="tab-upload mt-4">
              <nz-upload
                nzType="drag"
                [nzMultiple]="true"
                [nzLimit]="0"
                [(nzFileList)]="fileList"
                [nzBeforeUpload]="beforeUpload">
                <p class="ant-upload-drag-icon">
                  <i nz-icon nzType="upload"></i>
                </p>
                <p class="ant-upload-text">
                  {{'goodsReceiptPODetail.attachments.title' | translate}}
                </p>
                <p class="ant-upload-hint">
                  {{'goodsReceiptPODetail.attachments.description' | translate}}
                </p>
              </nz-upload>

              <button class="btn btn-labeled btn-send mt-2" (click)="onUpload()">
                <span class="btn-label">
                  <i class="material-icons">cloud_upload</i>
                </span>
                <span class="button-label">
                  {{'general.button.upload' | translate}}
                </span>
              </button>

            </div>
          </mat-tab>
        </mat-tab-group>
      </div>
    </div>
  </div>
</div>


<p-dialog [(visible)]="displayPurchaseOrders"
          [contentStyle]="{'overflow':'visible'}"
          [modal]="true"
          [responsive]="true"
          [style]="{width: '80%'}"
          appendTo="body">
  <p-header>
        <span class="dialog-header">{{'goodsReceiptPODetail.goodsReceipt.supplierName' | translate}}
          {{goodsReceiptPOForm.controls.supplierName.value}}
        </span>
  </p-header>
  <div class="dialog-body">
    <div class="row mt-3">
      <div class="col-sm-12">
        <p-table #tablePurchaseOrder
                 [resizableColumns]="true"
                 [scrollable]="true"
                 [value]="purchaseOrdersList"
                 scrollHeight="500px">
          <ng-template pTemplate="colgroup">
            <colgroup>
              <col>
              <col>
              <col>
            </colgroup>
          </ng-template>
          <ng-template pTemplate="header">
            <tr>
              <th data-qe-id="table-thead-goodsReceipt-check-box" pResizableColumn width="2.5%">
                <div class="pretty p-icon p-curve p-has-indeterminate">
                  <input id="dialog-select-all"
                         [checked]="allSelected"
                         (click)="selectAllPurchaseOrders($event)"
                         type="checkbox"/>
                  <div class="state">
                    <i class="icon material-icons">done</i>
                    <label></label>
                  </div>
                </div>
              </th>
              <th data-qe-id="table-thead-goodsReceipt-createdDate" pResizableColumn>
                {{'goodsReceiptPODetail.goodsReceipt.createdDate' | translate}} </th>
              <th data-qe-id="table-thead-goodsReceipt-documentNo" pResizableColumn>
                {{'goodsReceiptPODetail.goodsReceipt.documentNo' | translate}} </th>
              <th data-qe-id="table-thead-goodsReceipt-buyer" pResizableColumn>
                {{'goodsReceiptPODetail.goodsReceipt.buyer' | translate}} </th>
              <th data-qe-id="table-thead-goodsReceipt-creator" pResizableColumn>
                {{'goodsReceiptPODetail.goodsReceipt.creator' | translate}} </th>
            </tr>
            <tr>
              <th class="th-filter" width="2.5%"></th>
              <th class="th-filter">
                <app-date-picker (valueChange)="sortDatePurchaseOrders($event, tablePurchaseOrder)"
                                 data-qe-id="detail-form-receipted-date">
                </app-date-picker>
              </th>
              <th class="th-filter">
                <input (input)="tablePurchaseOrder.filter($event.target.value, 'documentNumber', 'equals')"
                       class="form-control"
                       type="text"/>
              </th>
              <th class="th-filter">

              </th>
              <th class="th-filter">
                <jaja-select-list class="flex-grow-1"
                                  [getList]="goodsReceiptPoDetailRepository.getSupplierList.bind(goodsReceiptPoDetailRepository)"
                                  key="code"
                                  [searchable]="true">
                  <ng-template #label #option let-code="code">
                    {{code}}
                  </ng-template>
                </jaja-select-list>
              </th>
            </tr>
          </ng-template>
          <ng-template let-index="rowIndex" let-purchaseOrder pTemplate="body">
            <tr [attr.data-qe-id]="'table-tbody-row-' + index">
              <td width="2.5%">
                <div class="pretty p-icon p-curve p-has-indeterminate">
                  <input [(ngModel)]="purchaseOrder.isSelected" type="checkbox"/>
                  <div class="state">
                    <i class="icon material-icons">done</i>
                    <label></label>
                  </div>
                </div>
              </td>
              <td class="ui-resizable-column"> {{purchaseOrder.documentDate | date: 'dd/MM/yyyy'}} </td>
              <td class="ui-resizable-column"> {{purchaseOrder.documentNumber}} </td>
              <td class="ui-resizable-column"> {{purchaseOrder.buyerName}} </td>
              <td class="ui-resizable-column"> {{purchaseOrder.ownerName}} </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>
  </div>
  <p-footer>
    <div class="row">
      <div class="col-sm-12">
        <div class="page-actions d-flex justify-content-end">
          <button (click)="combineGoodsReceiptPO()" class="btn btn-labeled btn-save-dialog">
            <span class="btn-label"><i class="material-icons">save</i></span>
            <span class="button-label">
                            {{'goodsReceiptPODetail.button.add' | translate}}
                        </span></button>
          <button (click)="displayPurchaseOrders = false" class="btn btn-labeled btn-cancel">
            <span class="btn-label"><i class="material-icons"> highlight_off</i></span>
            <span class="button-label">
                            {{'general.button.cancel' | translate}}
            </span></button>
        </div>
      </div>
    </div>
  </p-footer>
</p-dialog>
